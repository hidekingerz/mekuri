# mekuri - アーキテクチャ設計書

## 全体構成

```
┌─────────────────────────────────────────────────┐
│                   Tauri App                     │
│                                                 │
│  ┌──────────────┐       ┌────────────────────┐  │
│  │ メインウィンドウ │       │ ビューワーウィンドウ   │  │
│  │  (React)     │       │  (React)           │  │
│  │              │       │                    │  │
│  │ フォルダツリー  │──開く──▶│ 見開きビューワー     │  │
│  │              │       │                    │  │
│  └──────┬───────┘       └────────┬───────────┘  │
│         │                        │              │
│  ───────┼────── Tauri IPC ───────┼──────────    │
│         │                        │              │
│  ┌──────┴────────────────────────┴───────────┐  │
│  │            Rust バックエンド                 │  │
│  │                                           │  │
│  │  ┌─────────────┐  ┌────────────────────┐  │  │
│  │  │ フォルダ走査   │  │ アーカイブ画像抽出   │  │  │
│  │  │ (fs module) │  │ (archive module)  │  │  │
│  │  └─────────────┘  └────────────────────┘  │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

## レイヤー構成

### 1. フロントエンド（React / TypeScript）

UI の描画とユーザー操作を担当する。Tauri の IPC（`invoke`）経由で Rust バックエンドと通信する。

| コンポーネント | 責務 |
|---------------|------|
| `FolderTree` | ディレクトリ階層のツリー表示・操作 |
| `SpreadViewer` | 見開き画像表示・ページ送り |
| `Toolbar` | ルートフォルダ選択等のアクション |

### 2. バックエンド（Rust）

ファイルシステム操作とアーカイブ処理を担当する。Tauri Command として公開し、フロントエンドから呼び出す。

| モジュール | 責務 |
|-----------|------|
| `fs` | ディレクトリ走査、ファイル一覧取得 |
| `archive` | アーカイブの展開、画像エントリ一覧取得、画像データ抽出 |

## Tauri IPC コマンド設計

### フォルダ走査

```
Command: read_directory
Input:   { path: string }
Output:  DirectoryEntry[]

DirectoryEntry {
  name: string
  path: string
  is_dir: boolean
  is_archive: boolean
}
```

ツリーの遅延読み込みに対応する。フォルダを展開した時点でそのフォルダの直下のみを取得する。

### アーカイブ画像一覧取得

```
Command: list_archive_images
Input:   { archive_path: string }
Output:  string[]   // 画像エントリ名の自然順ソート済みリスト
```

### アーカイブ画像データ取得

```
Command: get_archive_image
Input:   { archive_path: string, entry_name: string }
Output:  number[]   // 画像バイナリデータ（Base64 or バイト配列）
```

## ウィンドウ管理

Tauri のマルチウィンドウ機能を使用する。

- メインウィンドウ: アプリ起動時に1つ生成
- ビューワーウィンドウ: アーカイブ選択時に `WebviewWindow` で動的に生成
  - ウィンドウラベルにはアーカイブパスのハッシュ等を使い一意にする
  - 同じアーカイブを二重に開かない制御を行う

## データフロー

### フォルダツリー表示

```
ユーザー操作: フォルダ展開
  → React: invoke("read_directory", { path })
  → Rust: fs::read_dir → フィルタリング・ソート
  → React: ツリーノード追加描画
```

### アーカイブ閲覧

```
ユーザー操作: アーカイブファイルをクリック
  → React (メイン): 新しい WebviewWindow を生成
  → React (ビューワー): invoke("list_archive_images", { archive_path })
  → Rust: archive::list_images → 自然順ソート済みリスト返却
  → React (ビューワー): 先頭ページの画像を取得・表示

ユーザー操作: ページ送り
  → React (ビューワー): invoke("get_archive_image", { archive_path, entry_name })
  → Rust: archive::get_image → 画像バイナリ返却
  → React (ビューワー): Base64 → data URL → <img> 表示
```

## エラーハンドリング方針

### バックエンド（Rust）

- すべての IPC コマンドは `Result<T, String>` を返す（Tauri の制約）
- エラーメッセージは英語で、原因が分かる程度に詳細に記述する

### フロントエンド（React）

各コンポーネントでエラー状態を管理し、ユーザーに視覚的にフィードバックする。

| コンポーネント | エラー発生箇所 | 表示方法 |
|---------------|---------------|---------|
| `FolderTree` | ルートディレクトリ読み込み失敗 | ツリー領域にエラーメッセージを表示 |
| `FolderTree` | サブフォルダ展開失敗 | 子ノードを空配列として扱い、静かに処理 |
| `ViewerApp` | アーカイブ画像一覧の取得失敗 | エラー画面を表示（エラー詳細付き） |
| `ViewerApp` | アーカイブ内に画像なし | 「No images found」メッセージを表示 |
| `SpreadViewer` | 個別の画像読み込み失敗 | ページ上部にエラーメッセージを表示（ナビゲーションは維持） |
