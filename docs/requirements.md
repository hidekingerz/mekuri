# mekuri - 要件定義書

## 概要

**mekuri** は、圧縮ファイル（ZIP/RAR等）内の画像および PDF ファイルを見開き表示で閲覧するためのデスクトップアプリケーションである。Tauri v2（Rust + React）で構成される。

## 用語定義

| 用語 | 説明 |
|------|------|
| アーカイブ | ZIP, RAR 等の圧縮ファイル |
| PDF | PDF 形式のファイル（pdfjs-dist でレンダリング） |
| 見開き表示 | 2ページを左右に並べて表示するモード |
| 単ページ表示 | 1ページずつ表示するモード |
| 読み方向 | ページの進行方向。RTL（右→左、漫画等）と LTR（左→右、PDF等）がある |
| フォルダツリー | ディレクトリ階層をツリー形式で表示するUI |
| お気に入り | ユーザーが登録したルートフォルダの一覧 |
| ネストアーカイブ | アーカイブ内に含まれるアーカイブファイル |
| 兄弟アーカイブ | 同一フォルダ内の他のアーカイブファイル |

## ウィンドウ構成

アプリケーションは2つのウィンドウで構成される。

### 1. メインウィンドウ

お気に入りフォルダの管理、フォルダツリーによるファイルブラウジング、アーカイブファイルの一覧表示を担当する。3カラムレイアウトで構成される。

**機能要件:**

- FR-M1: お気に入りフォルダを登録・削除できる（フォルダ選択ダイアログまたはコンテキストメニュー）
- FR-M2: お気に入りフォルダ配下をフォルダツリーとして表示する
- FR-M3: フォルダの展開・折りたたみができる
- FR-M4: サブフォルダを持たないフォルダはシェブロン（展開アイコン）を非表示にする
- FR-M5: 選択中のフォルダ内のアーカイブファイルおよび PDF ファイルをファイルリストとして一覧表示する
- FR-M6: アーカイブファイル（ZIP/RAR）および PDF をアイコンで識別表示する
- FR-M7: アーカイブファイルまたは PDF をクリックするとビューワーウィンドウを開く
- FR-M8: 同じアーカイブが既に開かれている場合は、そのウィンドウにフォーカスする
- FR-M9: フォルダツリーのコンテキストメニューからフォルダをお気に入りに追加できる
- FR-M10: フォルダツリーとファイルリストの境界をドラッグしてカラム幅を変更できる
- FR-M11: 隠しファイル（`.` で始まるファイル・フォルダ）は表示しない
- FR-M12: ディレクトリ・アーカイブの表示順は自然順ソートとし、ディレクトリを先に表示する

### 2. ビューワーウィンドウ

アーカイブ内の画像を見開き表示する。

**機能要件:**

- FR-V1: アーカイブ内の画像ファイルを自然順（natural sort）でソートして表示する
- FR-V2: 見開き表示（2ページ並列）をデフォルトとする
- FR-V3: ページ送り（次へ/前へ）ができる（キーボード・クリック・マウスホイール）
- FR-V4: 読み方向を RTL（右→左）と LTR（左→右）で切り替えられる
  - アーカイブはデフォルト RTL、PDF はデフォルト LTR
  - 読み方向に応じてページ配置・クリック領域・キーボード操作・プログレスバーの進行方向が反転する
- FR-V5: 画像をウィンドウサイズに合わせてフィットさせる
- FR-V6: 先頭ページ（表紙）は単ページ表示とする
- FR-V7: アーカイブ内にネストされたアーカイブがある場合、選択UIを表示する
- FR-V8: ネストアーカイブを一時ファイルとして展開し、閲覧できる
- FR-V9: プログレスバーを表示し、クリックで任意のページにジャンプできる
- FR-V10: Alt+上下矢印キーで同一フォルダ内の兄弟アーカイブに移動できる
- FR-V11: ウィンドウタイトルにファイル名と現在位置を表示する（例: `file.zip [3/10] - mekuri`）
- FR-V12: 見開き表示と単ページ表示を切り替えられる
- FR-V13: PDF ファイルをページ画像としてレンダリングして表示する（pdfjs-dist 使用、CJK フォント対応）
- FR-V14: 右クリックのコンテキストメニューから表示モード切替・読み方向切替・ゴミ箱移動・ウィンドウクローズができる

### キーボード操作

キーボード操作は読み方向に応じて動作が変わる。

| キー | RTL（右→左） | LTR（左→右） | コンテキスト |
|------|-------------|-------------|------------|
| Space | 次の見開きへ | 次の見開きへ | ビューワー |
| ← | 次の見開きへ | 前の見開きへ | ビューワー |
| → | 前の見開きへ | 次の見開きへ | ビューワー |
| Home | 最初の見開きへ | 最初の見開きへ | ビューワー |
| End | 最後の見開きへ | 最後の見開きへ | ビューワー |
| マウスホイール | ページ送り（スロットル200ms） | 同左 | ビューワー |
| Alt+↑ | 次の兄弟ファイルへ | 同左 | ビューワー |
| Alt+↓ | 前の兄弟ファイルへ | 同左 | ビューワー |

### コンテキストメニュー（ビューワー）

| メニュー項目 | 動作 |
|-------------|------|
| 見開き表示 / 単ページ表示 | 表示モードを切り替える |
| RTL / LTR 切替 | 読み方向を切り替える |
| Move to Trash | ファイルをゴミ箱に移動する |
| Close Window | ビューワーウィンドウを閉じる |

### 設定の永続化

以下の設定は `tauri-plugin-store` により自動保存・復元される。

| 設定項目 | デフォルト値 |
|----------|------------|
| メインウィンドウサイズ | 1000 x 700 |
| ツリーカラム幅 | 300px |
| ビューワーウィンドウサイズ | 1200 x 900 |
| 表示モード | 見開き表示 |
| 読み方向 | ファイル種別による（アーカイブ: RTL、PDF: LTR） |
| お気に入りフォルダ一覧 | 空 |

## 対応フォーマット

### アーカイブ形式

| 形式 | 拡張子 |
|------|--------|
| ZIP | .zip, .cbz |
| RAR | .rar, .cbr |

注: `.7z` はフォルダツリー上でアーカイブとして認識されるが、画像抽出処理は未実装。

### PDF

| 形式 | 拡張子 |
|------|--------|
| PDF | .pdf |

PDF はフロントエンドで `pdfjs-dist` を使ってページ画像にレンダリングする。CJK フォント（日本語・中国語・韓国語）にも対応する。

### 画像形式（アーカイブ内）

| 形式 | 拡張子 |
|------|--------|
| JPEG | .jpg, .jpeg |
| PNG | .png |
| WebP | .webp |
| GIF | .gif（静止画として） |

## 非機能要件

- NFR-1: ページ送り操作はストレスなく行える応答速度とする
- NFR-2: Windows / macOS / Linux で動作する（Tauri対応プラットフォーム）
- NFR-3: 大量の画像を含むアーカイブ（1000枚以上）でもメモリを圧迫しない

## 将来的な拡張候補（スコープ外）

以下は初期リリースのスコープ外とし、将来的に検討する。

- しおり（ブックマーク）機能
- サムネイル一覧表示
- 画像の回転・拡大
- 7z 形式の画像抽出対応
